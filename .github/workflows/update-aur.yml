name: Publish Linux + AUR

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Upstream tag to build (e.g. 26.01.22-1.0)"
        required: false
      pkgver:
        description: "PKGVER to use in AUR (e.g. 26.01.22_1.0)"
        required: false
      assetver:
        description: "Asset version for deb names (e.g. 26.01.22)"
        required: false
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: write

jobs:
  publish-linux:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      pkgver: ${{ steps.resolve.outputs.pkgver }}
      assetver: ${{ steps.resolve.outputs.assetver }}
      skip: ${{ steps.release_check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Resolve upstream release metadata
        id: resolve
        env:
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_PKGVER: ${{ inputs.pkgver }}
          INPUT_ASSETVER: ${{ inputs.assetver }}
        run: |
          python - <<'PY'
          import json
          import os
          from urllib.request import urlopen

          upstream_repo = "iiPythonx/feishin"
          tag = os.environ.get("INPUT_TAG") or ""
          pkgver = os.environ.get("INPUT_PKGVER") or ""
          assetver = os.environ.get("INPUT_ASSETVER") or ""

          if tag:
              release_url = f"https://api.github.com/repos/{upstream_repo}/releases/tags/{tag}"
          else:
              release_url = f"https://api.github.com/repos/{upstream_repo}/releases/latest"

          with urlopen(release_url, timeout=10) as resp:
              data = json.load(resp)

          latest_tag = data["tag_name"]
          assets = data.get("assets", [])
          asset = next(
              (item for item in assets if item.get("name", "").endswith("linux-amd64.deb")),
              None,
          )
          if not asset:
              raise SystemExit("No linux-amd64.deb asset found in upstream release")

          asset_name = asset["name"]
          derived_assetver = asset_name.replace("feishin-", "").split("-linux-")[0]

          pkgver = pkgver or latest_tag.replace("-", "_")
          assetver = assetver or derived_assetver

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"tag={latest_tag}\n")
              handle.write(f"pkgver={pkgver}\n")
              handle.write(f"assetver={assetver}\n")

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as handle:
              handle.write(f"FEISHIN_TAG={latest_tag}\n")
              handle.write(f"FEISHIN_PKGVER={pkgver}\n")
              handle.write(f"FEISHIN_ASSETVER={assetver}\n")
              handle.write(f"UPSTREAM_REPO={upstream_repo}\n")

          print(f"Resolved upstream tag: {latest_tag}")
          PY
      - name: Check release exists
        id: release_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$FEISHIN_TAG" >/dev/null 2>&1; then
            echo "exists=1" >> "$GITHUB_OUTPUT"
            exists=1
          else
            echo "exists=0" >> "$GITHUB_OUTPUT"
            exists=0
          fi
          if [[ "${{ github.event_name }}" == "schedule" ]] && [[ "$exists" == "1" ]]; then
            echo "skip=1" >> "$GITHUB_OUTPUT"
          else
            echo "skip=0" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout upstream
        if: steps.release_check.outputs.skip != '1'
        run: |
          git clone --depth 1 --branch "$FEISHIN_TAG" "https://github.com/${UPSTREAM_REPO}.git" upstream
      - name: Apply optimize script
        if: steps.release_check.outputs.skip != '1'
        run: python .github/scripts/feishin_optimize.py upstream
      - name: Install PNPM
        if: steps.release_check.outputs.skip != '1'
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 9
      - name: Setup Node
        if: steps.release_check.outputs.skip != '1'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: upstream/pnpm-lock.yaml
      - name: Install dependencies
        if: steps.release_check.outputs.skip != '1'
        run: pnpm install
        working-directory: upstream
      - name: Build Linux packages
        if: steps.release_check.outputs.skip != '1'
        run: pnpm run package:linux:pr
        working-directory: upstream
      - name: Publish release assets
        if: steps.release_check.outputs.skip != '1' && steps.release_check.outputs.exists != '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=(upstream/dist/*.deb upstream/dist/*.tar.xz upstream/dist/*.yml upstream/dist/*.blockmap)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No release assets found in upstream/dist"
            exit 1
          fi
          gh release create "$FEISHIN_TAG" --title "$FEISHIN_TAG" --notes "Optimized build from ${UPSTREAM_REPO} ${FEISHIN_TAG}" "${files[@]}"

  publish-aur:
    runs-on: ubuntu-latest
    needs: publish-linux
    if: needs.publish-linux.result == 'success' && needs.publish-linux.outputs.skip != '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update PKGBUILD from release
        env:
          FEISHIN_TAG: ${{ needs.publish-linux.outputs.tag }}
          FEISHIN_PKGVER: ${{ needs.publish-linux.outputs.pkgver }}
          FEISHIN_ASSETVER: ${{ needs.publish-linux.outputs.assetver }}
        run: python .github/scripts/update_pkgbuild.py
      - name: Commit changes
        if: env.PKG_UPDATED == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "chore: update to ${NEW_PKGVER}"
      - name: Push changes
        if: env.PKG_UPDATED == '1'
        run: git push
      - name: Publish to AUR
        if: env.PKG_UPDATED == '1'
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: iipython-feishin-electron-bin
          pkgbuild: ./PKGBUILD
          assets: |
            ./iipython-feishin-electron.sh
          commit_username: github-actions[bot]
          commit_email: github-actions[bot]@users.noreply.github.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
