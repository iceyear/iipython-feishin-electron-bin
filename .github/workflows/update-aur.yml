name: Publish Linux + AUR

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Upstream tag to build (e.g. 26.01.22-1.0)"
        required: false
        default: '26.01.22-1.0'
      release_tag:
        description: "Release tag to create in this repo (e.g. 26.01.22-1.0-custom)"
        required: false
        default: '26.01.22-1.0_5'
      pkgver:
        description: "PKGVER to use in AUR (e.g. 26.01.22_1.0)"
        required: false
        default: '26.01.22_1.0_5'
      assetver:
        description: "Asset version for deb names (e.g. 26.01.22)"
        required: false
        default: '26.01.22'
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: write

jobs:
  publish-linux:
    runs-on: ubuntu-latest
    outputs:
      upstream_tag: ${{ steps.resolve.outputs.upstream_tag }}
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      pkgver: ${{ steps.resolve.outputs.pkgver }}
      assetver: ${{ steps.resolve.outputs.assetver }}
      skip: ${{ steps.release_check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Resolve upstream release metadata
        id: resolve
        env:
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_RELEASE_TAG: ${{ inputs.release_tag }}
          INPUT_PKGVER: ${{ inputs.pkgver }}
          INPUT_ASSETVER: ${{ inputs.assetver }}
        run: python .github/scripts/resolve_upstream_release.py
      - name: Check release exists
        id: release_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pkgbuild_upstream_tag="$(grep -E '^_upstream_tag=' PKGBUILD | head -n1 | cut -d'=' -f2 | tr -d '"')"
          if [[ -z "$pkgbuild_upstream_tag" ]]; then
            pkgbuild_upstream_tag="$(grep -E '^_tag=' PKGBUILD | head -n1 | cut -d'=' -f2 | tr -d '"')"
          fi
          if gh release view "$FEISHIN_TAG" >/dev/null 2>&1; then
            echo "exists=1" >> "$GITHUB_OUTPUT"
            exists=1
          else
            echo "exists=0" >> "$GITHUB_OUTPUT"
            exists=0
          fi
          if [[ "${{ github.event_name }}" == "schedule" ]] && [[ "$UPSTREAM_TAG" == "$pkgbuild_upstream_tag" ]]; then
            echo "skip=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ "${{ github.event_name }}" == "schedule" ]] && [[ "$exists" == "1" ]]; then
            echo "skip=1" >> "$GITHUB_OUTPUT"
          else
            echo "skip=0" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout upstream
        if: steps.release_check.outputs.skip != '1'
        run: |
          git clone --depth 1 --branch "$UPSTREAM_TAG" "https://github.com/${UPSTREAM_REPO}.git" upstream
      - name: Apply optimize script
        if: steps.release_check.outputs.skip != '1'
        run: python .github/scripts/feishin_optimize.py upstream
      - name: Install PNPM
        if: steps.release_check.outputs.skip != '1'
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10
      - name: Setup Node
        if: steps.release_check.outputs.skip != '1'
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: upstream/pnpm-lock.yaml
      - name: Install dependencies
        if: steps.release_check.outputs.skip != '1'
        run: pnpm install --no-frozen-lockfile && pnpm install --ignore-scripts=false abstract-socket
      - name: Build Linux packages
        if: steps.release_check.outputs.skip != '1'
        run: pnpm run package:linux:pr
        working-directory: upstream
      - name: Publish release assets
        if: steps.release_check.outputs.skip != '1' && steps.release_check.outputs.exists != '1'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=(upstream/dist/*.deb upstream/dist/*.AppImage upstream/dist/*.tar.xz upstream/dist/latest-*.yml upstream/dist/*.blockmap)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No release assets found in upstream/dist"
            exit 1
          fi
          gh release create "$FEISHIN_TAG" --title "$FEISHIN_TAG" --notes "Optimized build from ${UPSTREAM_REPO} ${UPSTREAM_TAG}" "${files[@]}"

  publish-aur:
    runs-on: ubuntu-latest
    needs: publish-linux
    if: needs.publish-linux.result == 'success' && needs.publish-linux.outputs.skip != '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Update PKGBUILD from release
        env:
          FEISHIN_TAG: ${{ needs.publish-linux.outputs.release_tag }}
          FEISHIN_UPSTREAM_TAG: ${{ needs.publish-linux.outputs.upstream_tag }}
          FEISHIN_PKGVER: ${{ needs.publish-linux.outputs.pkgver }}
          FEISHIN_ASSETVER: ${{ needs.publish-linux.outputs.assetver }}
        run: python .github/scripts/update_pkgbuild.py
      - name: Commit changes
        if: env.PKG_UPDATED == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "chore: update to ${NEW_PKGVER}"
      - name: Push changes
        if: env.PKG_UPDATED == '1'
        run: git push
      - name: Publish to AUR
        if: env.PKG_UPDATED == '1'
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: iipython-feishin-electron-bin
          pkgbuild: ./PKGBUILD
          assets: |
            ./iipython-feishin-electron.sh
          commit_username: github-actions[bot]
          commit_email: github-actions[bot]@users.noreply.github.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
